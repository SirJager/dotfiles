## =====================================================
## Plugin Manager
## =====================================================
set-environment -gF TMUX_PLUGIN_MANAGER_PATH '#{HOME}/.local/share/tmux/plugins'

if 'test ! -d "${TMUX_PLUGIN_MANAGER_PATH}/tpm"' {
  run 'mkdir -p "${TMUX_PLUGIN_MANAGER_PATH}"'
  run 'git clone https://github.com/tmux-plugins/tpm "${TMUX_PLUGIN_MANAGER_PATH}/tpm"'
  run '${TMUX_PLUGIN_MANAGER_PATH}/tpm/bin/install_plugins'
}

set -g @plugin 'tmux-plugins/tpm'                           # tmux plugin manager
set -g @plugin 'catppuccin/tmux'                            # catppuccin tmux theme
set -g @plugin 'tmux-plugins/tmux-yank'                     # yanking in tmux
set -g @plugin 'tmux-plugins/tmux-sensible'                 # 
set -g @plugin 'christoomey/vim-tmux-navigator'             # seamles navigation between tmux and neovim
set -g @plugin 'omerxx/tmux-floax'                          # floating terminal popup for tmux
set -g @plugin 'tmux-plugins/tmux-resurrect'              # save / restore tmux sessions
set -g @plugin 'tmux-plugins/tmux-continuum'              # 
set -g @plugin 'tmux-plugins/tmux-cpu'
set -g @plugin 'tmux-plugins/tmux-battery'
set -g @plugin 'dreknix/tmux-primary-ip'
set -g @plugin 'tmux-plugins/tmux-online-status'


## =====================================================
## General Settings
## =====================================================

new-session                     # auto create nEw session If no other exists

set -gq allow-passthrough on  # for images in tmux

set -g base-index 1           # start windows numbering at 1
setw -g pane-base-index 1     # make pane numbering consistent with windows
set -g renumber-windows on    # renumber windows when a window is closed
set-window-option -g pane-base-index 1

set -g set-titles on          # set terminal title
set -g allow-rename on        # allow renaming of windows
setw -g automatic-rename on   # rename window to reflect current program

setw -g aggressive-resize on  # useful when using sharing a session with different size terminals


set -g display-panes-time 800 # slightly longer pane indicators display time
set -g display-time 1000      # slightly longer status messages display time

set -g status-interval 10     # redraw status line every 10 seconds

set -g mouse on               # allow the mouse to resize windows and select tabs
set -g monitor-activity on    # activity

set -g bell-action any        # bell in another window should cause a bell in the current window
set -g visual-bell off        # Don't show distracting notifications
set -g visual-activity off    # Don't show distracting notifications
set -g focus-events on        # focus events enabled for terminals that support them

set -g history-limit 9999999  # Increase scrollback buffer size
set -g detach-on-destroy on   # don't detach tmux when killing a session

set -as terminal-features ",*:RGB" 
set -ag terminal-overrides ",xterm-256color:RGB"
set -g default-terminal "xterm-256color"
# set -g default-terminal "tmux-256color"

setw -g mode-keys vi          # Use Vi mode
set -s escape-time 0          # address vim mode switching delay (http://superuser.com/a/252717/65504)

set -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'  # Enable undercurl
set -as terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'  # underscore colours - needs tmux-3.0


## =====================================================
## Keybind Settings
## =====================================================

unbind C-b                     # unbind defaults 
unbind '"'                     # unbind defaults 
unbind %                       # unbind defaults 
unbind r                       # unbind for relaod
unbind u                       # used in quick windows below
unbind q                       # used in quick windows below
unbind p                       # unsed in floax floating term for tmux
unbind P                       # unsed in floax floating term for tmux

set -g prefix M-q             # set prefix
bind-key M-q send-prefix      # set prefix

bind-key e choose-session     # choose from active sessions

bind-key n new-window         # New window
bind -n M-h previous-window   # previous window
bind -n M-l next-window       # next window
bind Space last-window        # quick switch between two most recently used windows
bind Tab last-window          # quick switch between two most recently used windows


bind -r W kill-pane                   # kill current pane
bind -r m resize-pane -Z              # maximize current pane
bind -r j resize-pane -D 1            # resize pane to bottom
bind -r k resize-pane -U 1            # resize pane to up
bind -r l resize-pane -R 1            # resize pane to right
bind -r h resize-pane -L 1            # resize pane to left

bind-key i next-layout                                   # switch between horizontal and vertical layouts
bind '\' split-window -h -c "#{pane_current_path}"       #'"" split window vertically
bind '-' split-window -v -c "#{pane_current_path}"       # split window horizontally

bind Enter copy-mode # enter copy mode
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi C-v send -X rectangle-toggle
bind -T copy-mode-vi y send -X copy-selection-and-cancel
bind -T copy-mode-vi Escape send -X cancel
bind -T copy-mode-vi H send -X start-of-line
bind -T copy-mode-vi L send -X end-of-line


bind-key o command-prompt -p "open program: " "new-window '%%'"                                                            # open program
bind r source-file ~/.config/tmux/tmux.conf \; display "Reloaded Tmux Configs"                                             # "reload tmux configs"
bind-key y run -b "tmux show-buffer | xclip -selection clipboard"\; display-message "copied tmux buffer to clipboard"      # copy pane text to clipboard

# copy to wayland clipboard:  prefix; y                   # for others : https://github.com/gpakosz/.tmux/blob/5f1047550ba2ba16a27bf8c9ea958fbbf974598d/.tmux.conf#L128
if -b '[ "$XDG_SESSION_TYPE" = "wayland" ] && command -v wl-copy > /dev/null 2>&1' 'bind y run -b "\"\$TMUX_PROGRAM\" \${TMUX_SOCKET:+-S \"\$TMUX_SOCKET\"} save-buffer - | wl-copy"'


## =====================================================
## Popups And Shortcuts
## =====================================================

# bind -n M-G popup -d '#{pane_current_path}' -E -h 100% -w 100% -x 100% 'lazygit'                    #  lazygit
# bind -n M-P popup -d '#{pane_current_path}' -E -h 100% -w 100% -x 100% 'btop'                       #  btop process manager
bind -n M-X popup -d '#{pane_current_path}' -E -h 100% -w 100% -x 100% "tmux kill-session -a"       # kill other tmux sessions
# bind -n M-K popup -d '#{pane_current_path}' -E -h 100% -w 100% -x 100% "ps axch -o user:8,pid,%mem:5,%cpu:5,comm --sort=-%cpu | fzf --height 100% --layout=reverse --prompt='  USER      PID    %MEM   %CPU   COMMAND :  Kill ' | awk '{print $2}' | xargs -r sudo kill"


## =====================================================
## Quick Windows
## =====================================================

bind-key q new-window -n "sql client" -c "#{pane_current_path}" "lazysql"                     # lazysql client        : https://github.com/jorgerojas26/lazysql
# bind-key u new-window -n "rest client" -c "#{pane_current_path}" "atac -d ./atac"             # atac rest client      : yay -S atac https://github.com/Julien-cpsn/ATAC
bind-key t new-window -n "process manager" -c "#{pane_current_path}" "btop"                   # btop process man      : yay -S btop
bind-key s new-window -n "search n replace" -c "#{pane_current_path}" "serpl"                 # search and replace    : https://github.com/yassinebridi/serpl/releases
bind-key d new-window -n "docker" -c "#{pane_current_path}" "lazydocker"                      # lazy docker ui        : yay -S lazydocker
bind-key g new-window -n "git" -c "#{pane_current_path}" "lazygit"                            # lazy git ui           : yay -S lazygit
bind-key c new-window -n "doftiles" -c "#{pane_current_path}" "lazygit -p $mydotfiles"        # lazygit dotfiles      : lazygit in dotfiles dir
bind-key f new-window -n "yazi" -c "#{pane_current_path}" "yazi"                              # yazi term filemanager : https://github.com/mkchoi212/fac

# # =====================================================
# # Plugin Settings
# # =====================================================

set -g @floax-bind 'p'                        # toggle terminal:   prefix; p 
set -g @floax-bind-menu 'P'                   # floax menu:     shift+p
set -g @floax-width '90%'                     # floax width
set -g @floax-height '90%'                    # floax-height
set -g @floax-border-color 'magenta'          # floax border
set -g @floax-text-color 'blue'               # floax text color
set -g @floax-change-path 'false'             # floax change dir path



# # =====================================================
# # Theme Settings
# # link: https://github.com/catppuccin/tmux/discussions/317#discussioncomment-11064512
# # =====================================================

set -g status-position bottom   # tmux bar position
set -g status-style "bg=#{@thm_bg}" # tmux bar background
set -g status-justify "absolute-centre"  # tmux bar center

set -g @catppuccin_flavor "macchiato"
set -g @catppuccin_status_background "none"
set -g @catppuccin_window_status_style "none"
set -g @catppuccin_pane_status_enabled "off"
set -g @catppuccin_pane_border_status "off"

set -g @online_icon "ok"
set -g @offline_icon "nok"

# status left look and feel
set -g status-left-length 100
set -g status-left ""
set -ga status-left "#{?client_prefix,#{#[bg=#{@thm_red},fg=#{@thm_bg},bold]  #S },#{#[bg=#{@thm_bg},fg=#{@thm_green}]  #S }}"
set -ga status-left "#[bg=#{@thm_bg},fg=#{@thm_overlay_0},none]│"
set -ga status-left "#[bg=#{@thm_bg},fg=#{@thm_maroon}]  #{pane_current_command} "
set -ga status-left "#[bg=#{@thm_bg},fg=#{@thm_overlay_0},none]│"
set -ga status-left "#[bg=#{@thm_bg},fg=#{@thm_blue}]  #{=/-32/...:#{s|$USER|~|:#{b:pane_current_path}}} "
set -ga status-left "#[bg=#{@thm_bg},fg=#{@thm_overlay_0},none]#{?window_zoomed_flag,│,}"
set -ga status-left "#[bg=#{@thm_bg},fg=#{@thm_yellow}]#{?window_zoomed_flag,  zoom ,}"


# status right look and feel
set -g status-right-length 100
set -g status-right ""
set -ga status-right "#{?#{e|>=:10,#{battery_percentage}},#{#[bg=#{@thm_red},fg=#{@thm_bg}]},#{#[bg=#{@thm_bg},fg=#{@thm_pink}]}} #{battery_icon} #{battery_percentage} "
set -ga status-right "#[bg=#{@thm_bg},fg=#{@thm_overlay_0}, none]│"
set -ga status-right "#[bg=#{@thm_bg}]#{?#{==:#{online_status},ok},#[fg=#{@thm_mauve}] 󰖩 on ,#[fg=#{@thm_red},bold]#[reverse] 󰖪 off }"
set -ga status-right "#[bg=#{@thm_bg},fg=#{@thm_overlay_0}, none]│"
set -ga status-right "#[bg=#{@thm_bg},fg=#{@thm_blue}] 󰭦 %Y-%m-%d 󰅐 %H:%M "


# pane border look and feel
setw -g pane-border-status bottom
setw -g pane-border-format ""
setw -g pane-active-border-style "bg=#{@thm_bg},fg=#{@thm_overlay_0}"
setw -g pane-border-style "bg=#{@thm_bg},fg=#{@thm_surface_0}"
setw -g pane-border-lines single

# window look and feel
set -wg automatic-rename on
set -g automatic-rename-format "Window"

set -g window-status-format " #I#{?#{!=:#{window_name},Window},: #W,} "
set -g window-status-style "bg=#{@thm_bg},fg=#{@thm_rosewater}"
set -g window-status-last-style "bg=#{@thm_bg},fg=#{@thm_peach}"
set -g window-status-activity-style "bg=#{@thm_red},fg=#{@thm_bg}"
set -g window-status-bell-style "bg=#{@thm_red},fg=#{@thm_bg},bold"
set -gF window-status-separator "#[bg=#{@thm_bg},fg=#{@thm_overlay_0}]│"

set -g window-status-current-format " #I#{?#{!=:#{window_name},Window},: #W,} "
set -g window-status-current-style "bg=#{@thm_peach},fg=#{@thm_bg},bold"

# # =====================================================
# # Initialize tmux plugin manager and source all plugins
# # =====================================================
run "#{TMUX_PLUGIN_MANAGER_PATH}/tpm/tpm"
